# 用例 #231：AI访问权限审计器

**角色**：开发工程师 / DevOps工程师 / 安全工程师 / 平台工程师 | **行业**：科技、SaaS、金融科技、医疗、企业 | **任务**：IAM审计、最小权限实施、合规审查

---
## 详细介绍

**痛点：权限蔓延不断积累，直到演变为安全危机**

最小权限原则被普遍理解，也被普遍违反。不是出于恶意——而是快速发展的工程组织的自然运作机制所致。当开发人员需要临时访问生产数据库进行紧急调试时，应急处理方式是先授予宽泛权限，之后再清理。之后永远不会到来。当服务账号需要一个新功能的权限时，授予管理员级别的访问比仔细划定最小所需策略更容易。当团队成员离职、IAM用户被停用后，他们所属的访问组可能没有被处理——权限就这样延续下去。六个月后，审计发现40%的活跃服务账号拥有管理员或近管理员权限，但实际从未使用过，另外还有15名用户保留着三个已结束项目遗留下来的跨账号访问。

云环境中这一问题的规模令人震惊。AWS、GCP和Azure各自在数百个服务中提供数千个离散权限。一个善意的开发人员被交付为新服务划定IAM权限的任务时，面临的是一个无法通过阅读文档解决的组合爆炸问题——它需要工具支持。没有这些工具，阻力最小的路径就是通配符权限和托管管理员策略。一个运行在AWS上的典型50人初创公司拥有数千个IAM策略、数百个角色、数十个服务账号，却没有一个人真正理解完整的权限图谱。

合规维度使安全风险更加复杂。SOC 2、ISO 27001、PCI DSS和HIPAA都要求可证明的最小权限访问控制、定期访问审查、职责分离以及特权访问的审计追踪。在审计中未能满足这些控制要求，会产生阻碍企业销售的发现项、引发客户安全审查，并需要紧急整改项目。组织通常在审计师到来时才发现合规差距——在最糟糕的时机，承受最大的时间压力。

**COCO如何解决**

COCO的AI访问权限审计器审查云提供商和Kubernetes集群中的IAM策略、RBAC配置和服务账号权限，以识别过度特权、职责分离违规和合规差距——产出按风险和复杂度排序的整改建议。

1. **IAM策略分析**：COCO大规模分析云IAM。
   - 审查AWS IAM策略（内联、托管、边界）、角色和组中的过度宽松声明
   - 识别通配符权限（`s3:*`、`ec2:*`、`*:*`），分析实际需要哪些具体权限与授予的权限的差距
   - 检测特权提升路径：即使没有显式管理员授权，某些权限组合也允许主体提升至管理员访问（例如`iam:CreatePolicyVersion`、`iam:AttachRolePolicy`、`lambda:CreateFunction` + `iam:PassRole`）
   - 分析GCP IAM绑定中的过于宽泛角色分配和应被预定义或自定义角色替换的原始角色（Owner、Editor）
   - 审查Azure RBAC角色分配的范围适当性（订阅级别 vs. 资源组 vs. 资源）

2. **服务账号审计**：服务账号通常是权限最过度的主体。
   - 枚举所有服务账号，将授予的权限与实际使用情况进行比较（使用CloudTrail、GCP审计日志或Azure活动日志确定哪些权限被实际使用）
   - 识别"僵尸"服务账号：过去90天内没有使用记录但保留有效权限的服务账号
   - 检测具有人员级别交互权限（控制台访问、密码凭证）的服务账号——这些应仅限密钥方式
   - 识别跨多个服务共享的服务账号（应按服务独立设置以控制爆炸半径）
   - 生成权限使用报告：已授予 vs. 已使用，突出显示未使用权限作为整改候选项

3. **Kubernetes RBAC分析**：Kubernetes引入了其特有的权限复杂性。
   - 审查ClusterRole和Role中过于宽泛的规则：资源、动词或API组上的通配符
   - 识别绑定到强大ClusterRole（尤其是`cluster-admin`）的ServiceAccount
   - 检测命名空间隔离违规：主体拥有超出必要的跨命名空间访问
   - 审查RBAC继承关系：RoleBinding和ClusterRoleBinding的交互方式
   - 标记常见Kubernetes RBAC反模式：绑定到`system:masters`、使用`*`动词、向生产Pod授予`exec`权限

4. **职责分离分析**：确保没有单一主体可以单独执行高风险操作组合。
   - 识别职责分离违规：可以同时批准和执行敏感操作的主体（例如既可创建IAM策略又可附加它们）
   - 审查生产访问控制：是否有开发人员拥有直接的生产写访问权，但没有变更管理控制？
   - 检查数据访问控制：开发人员是否可以直接查询生产PII数据库？
   - 识别敏感操作缺失的审批工作流

5. **合规映射**：将访问发现项与具体合规要求对应。
   - 将每个发现项映射到相关合规控制：SOC 2 CC6.1/CC6.3（逻辑访问）、PCI DSS 7（知悉必要访问）、HIPAA §164.312(a)(1)（访问控制）、ISO 27001 A.9
   - 生成合规就绪的访问审查报告，记录审查内容、时间和发现
   - 识别监管机构和审计师重点关注的"高风险"权限组合
   - 跟踪定期审查要求的访问审查完成状态

6. **整改优先级排序与策略生成**：不只是"这里有问题"，而是"这是修复方案"。
   - 按风险对发现项进行优先级排序：严重（特权提升路径、通配符管理员）> 高（未使用的管理员权限）> 中（非关键过度宽泛访问）> 低（轻微策略卫生问题）
   - 为已识别的过度宽松策略生成最小权限替换策略
   - 产出带有工作量估算和排序建议的访问清理计划
   - 使用观察到的访问模式为新服务账号生成权限范围建议

**量化成果**

- **权限减少**：典型首次审计发现35-50%的已授予权限未被使用，是整改候选项
- **特权提升路径消除**：COCO在成熟AWS环境中平均发现12-25条特权提升路径——大多数此前未知
- **合规就绪**：SOC 2准备所需的访问审查文档从手动的2-4周缩短至4-8小时
- **服务账号卫生**：僵尸服务账号的识别和清理平均减少30%的攻击面
- **审计发现项减少**：在外部审计前完成COCO审计的组织，访问相关审计发现项减少60-70%
- **事件风险**：实施最小权限控制的组织，凭证被盗攻击的影响降低45%（凭证泄露时爆炸半径更小）

**受益人群**

- **DevOps / 平台工程师**：理解所管理基础设施的完整权限图景，系统性地解决差距
- **安全工程师**：无需逐策略手动审查，即可扩大跨云账号和Kubernetes集群的访问审查覆盖范围
- **技术负责人 / 开发工程师**：获得新基础设施代码中服务账号权限正确划定的指导
- **CTO / CISO**：通过有据可查的、系统性的访问审查，向审计师和企业客户证明最小权限合规

---

## 实用提示词

**提示词1：AWS IAM审计**
```
我需要对我们的AWS IAM权限进行全面审计，排查过度特权和安全风险。

AWS环境背景：
- 账号数量：[N个AWS账号]
- 账号结构：[单账号 / 使用Organizations的多账号 / 独立账号]
- 大致规模：[N个IAM用户，N个角色，N个服务账号]
- 主要使用的服务：[EC2、RDS、S3、Lambda、EKS等]
- 合规要求：[SOC 2 / PCI DSS / HIPAA / 仅内部]

需要分析的材料（粘贴或附件）：
- IAM策略文档：[粘贴JSON或附件]
- 附有关联策略的IAM角色列表：[描述或附件]
- CloudTrail使用数据：[可用 是/否]

已知的关注点：
- [例如："几个角色有AdministratorAccess，可能不必要"]
- [例如："我们有来自旧项目的服务账号，可能仍处于活跃状态"]
- [例如："开发人员有直接的生产S3存储桶访问权限"]

请：
1. 识别所有过度宽松的策略，附具体需要整改的策略声明
2. 检测当前权限集中的特权提升路径
3. 识别未使用的权限（如果CloudTrail可用，过去90天内授予但未使用的权限）
4. 标记通配符权限并推荐具体的替代方案
5. 识别僵尸IAM用户/角色（近期无活动记录）
6. 生成附工作量估算的风险优先级整改清单
7. 针对前5个问题，生成替代的最小权限策略JSON
```

**提示词2：Kubernetes RBAC安全审查**
```
我需要审计我们的Kubernetes RBAC配置以排查安全风险。

集群背景：
- Kubernetes版本：[版本]
- 云提供商：[EKS / GKE / AKS / 自托管]
- 命名空间数量：[N]
- ServiceAccount数量：[N]
- 工作负载类型：[描述：Web服务、批处理任务、数据处理等]

RBAC配置（粘贴或附件）：
- ClusterRole列表：[粘贴`kubectl get clusterroles -o yaml`输出或描述]
- ClusterRoleBinding：[粘贴`kubectl get clusterrolebindings -o yaml`]
- 关键命名空间的命名空间级Role和RoleBinding：[粘贴或描述]
- 关注的ServiceAccount：[列出你已知道的]

已知的关注点：
- [例如："我们认为某些服务账号可能有cluster-admin绑定"]
- [例如："我们在多个服务间共用一个ServiceAccount"]
- [例如："某些工作负载对生产Pod有exec访问权限"]

请：
1. 识别所有授予cluster-admin或等效权限的ClusterRoleBinding
2. 找出权限超出其实际运营需求的ServiceAccount
3. 检测应被限定范围的通配符权限（*，动词，API组）
4. 识别违反隔离原则的跨命名空间RBAC
5. 标记RBAC反模式（生产环境exec、不需要Secret的工作负载获得Secret访问权限）
6. 为最高风险发现项生成替代RBAC清单
```

**提示词3：合规审计的访问审查**
```
我需要为即将到来的[SOC 2 / ISO 27001 / PCI DSS]审计进行正式访问审查。

访问审查范围：
- 云账号：[列出]
- Kubernetes集群：[列出]
- 需要访问审查的关键系统：[数据库、支付系统、管理控制台等]
- 审查期间：[例如："审查截至[日期]的访问情况"]
- 用户规模：[N名员工，N名外包人员，N个服务账号]

当前访问清单（附件或描述）：
- 用户到角色映射：[格式，如何提供]
- 服务账号清单：[列表或附件]
- 特权访问清单：[谁有管理员/提升权限的访问]

合规背景：
- 标准：[SOC 2 / ISO 27001 / PCI DSS / HIPAA]
- 需要证明的具体控制项：[如已知，列出控制ID]
- 与访问相关的历史审计发现项：[如有，描述]

请：
1. 识别违反最小权限原则的访问
2. 标记代表职责分离违规的访问
3. 识别过期/孤立的访问（已离职员工、已下线服务）
4. 产出合规就绪的访问审查报告，记录范围、方法和发现项
5. 生成访问审查人员（业务负责人认证访问适当性）的管理层确认清单
6. 将发现项映射到具体合规控制差距，附整改建议
```
