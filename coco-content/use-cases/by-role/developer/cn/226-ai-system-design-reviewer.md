# 用例 #226：AI 系统设计审查器

**角色**：开发工程师 / 高级工程师 / 技术负责人 / 解决方案架构师 | **行业**：科技、SaaS、金融科技、企业软件 | **任务**：架构审查、设计验证、可扩展性评估

---
## 详细介绍

**痛点：在信息孤岛中做出的架构决策，往往发现得太晚**

系统设计是软件工程中杠杆率最高的活动之一——一个好的架构决策可以带来数年的红利，而一个糟糕的决策则会让绕过它的成本不断攀升。问题在于，大多数架构决策都由小团体在有限时间内做出，依赖于恰好在场的人的经验。设计评审即便存在，也往往流于形式：一个 30 分钟的会议，所有人点头附和，顾虑因为怕引发冲突而不被说出口，评审结束时没有任何关于已考虑的权衡的书面记录。六个月后，系统已上线，一个在设计阶段就显而易见的故障模式——只要有人有时间仔细想想就会发现的——触发了第一次重大事故。

架构失败的具体模式有充分记录：产生级联故障点的同步调用链、外部依赖缺少熔断器、数据量达到生产规模后无法在不宕机的情况下迁移的数据库 Schema、在产品吸引需要冗余 SLA 的企业客户后成为负债的单区域架构、使服务解耦变得不可能的共享数据库模式、100 个用户时运行良好但到 10,000 个用户时产生惊群效应的缓存策略。这些模式都是已知的——它们出现在每一本系统设计书籍中。但在构建前捕获它们，需要对照全面清单进行结构化审查，结合对故障模式的实际经验。这恰恰是大多数团队所缺乏的。

经济逻辑强烈支持架构投资：Boehm 的变更成本曲线显示，在设计阶段修复架构问题成本为 1×，而在部署后修复成本为 10–100×。一次发现根本性可扩展性缺陷的 2 小时架构审查，可以节省数月的紧急重构以及容量事故期间潜在的数百万损失。

**COCO 如何解决**

COCO 的 AI 系统设计审查器根据最佳实践、可扩展性模式和已知故障模式，评估架构图、设计文档和技术规范——在任何基础设施代码编写之前提供结构化、全面的反馈。

1. **架构模式分析**：COCO 对多个架构维度进行系统性审查。
   - 评估通信模式：同步 vs. 异步、请求-响应 vs. 事件驱动，以及每种选择在哪里引入耦合或故障放大
   - 审查数据存储决策：数据库类型选择（关系型 vs. 文档型 vs. 时序型 vs. 图数据库）、分片策略、复制方式和 Schema 演进计划
   - 评估服务边界设计：服务是否按正确的领域边界划分？是否存在不适当的数据共享？是否有循环依赖？
   - 评估 API 设计选择：REST vs. GraphQL vs. gRPC、版本控制策略、向后兼容方法
   - 检查一致性模型对齐：所选一致性级别（最终一致 vs. 强一致）是否与每种数据类型的业务需求相匹配？

2. **可扩展性模式审查**：这个系统能处理 10 倍的当前负载吗？100 倍？
   - 识别水平扩展阻碍：有状态的应用服务器、共享内存缓存、没有连接池的数据库连接
   - 审查负载均衡策略：Session 亲和性要求、健康检查配置、连接排空
   - 评估数据库扩展计划：读副本、缓存层、连接池，以及单主库不够用时的方案
   - 评估队列/异步处理设计：死信队列、幂等性保证、消息顺序要求 vs. 实际方案
   - 识别"扩展悬崖"——当前架构崩溃并需要结构性重做的负载点（如从单 DB 到分片、从单区域到多区域）

3. **故障模式与弹性分析（FMEA）**：每个外部依赖都是故障风险。
   - 识别单点故障：没有冗余的服务、没有降级的依赖、变为可用性乘数的同步调用链
   - 审查熔断器实现：是否有防止下游服务降级引发级联故障的保护？
   - 评估超时和重试策略：超时设置是否合理？重试是否使用指数退避加抖动？
   - 评估优雅降级：当服务 X 不可用时，系统如何运行？是否定义了降级模式行为？
   - 识别高流量场景中的惊群效应和缓存击穿风险

4. **安全与合规架构审查**：安全属于设计阶段，而非部署后审计。
   - 审查信任边界定义：身份验证和授权在哪里强制执行？是否存在缺口？
   - 评估数据加密方案：传输加密（TLS 配置）、静态加密和密钥管理
   - 评估 PII/敏感数据的数据流：敏感数据是否最小化、适当隔离和审计？
   - 检查合规架构要求：GDPR 数据驻留、SOC2 日志记录、PCI DSS 网络分段
   - 审查 Secret 管理方式：硬编码密钥 vs. Vault 集成、轮换策略

5. **运维就绪性评估**：构建只是工作的一半。
   - 评估可观测性设计：指标、日志和追踪是内建的还是事后添加的？业务关键指标能从这个设计中测量吗？
   - 审查部署策略：能否无宕机部署？回滚计划是什么？
   - 评估配置管理：环境特定配置、功能开关、运行时重配置能力
   - 识别设计创造的运维手册需求

6. **设计文档与 ADR 生成**：审查发现成为永久的架构记录。
   - 生成按严重性分类的结构化审查报告（关键 / 高 / 中 / 低）
   - 生成架构决策记录（ADR），记录关键决策、已考虑的替代方案和理由
   - 创建"设计假设"文档，明确记录应被验证的假设
   - 为关键发现建议具体的设计替代方案并附权衡分析

**量化结果**

- **预生产问题检测**：使用结构化 AI 设计审查的团队，在实现开始前捕获 60–70% 的架构问题
- **事故减少**：持续进行设计审查的团队，架构层事故（可扩展性失败、级联中断、数据完整性问题）减少 45%
- **审查完整性**：COCO 辅助的审查覆盖 95% 以上的标准审查维度，而非结构化的同伴审查仅覆盖 40–60%
- **审查吞吐量**：全面设计审查时间从 2–3 天的高级工程师时间缩减至 COCO 辅助下的 4–6 小时
- **ADR 合规率**：设计文档完整性从 20% 的决策有记录 → 85% 以上（有 COCO 生成的 ADR）
- **变更成本**：在设计审查阶段 vs. 部署后捕获架构问题，每个问题节约 10–50 倍成本

**谁会受益**

- **解决方案架构师**：获得全面的、清单驱动的审查覆盖，以系统性广度补充人类经验
- **高级工程师 / 技术负责人**：无需在每次审查上花 2 天，即可对团队成员的设计提案进行深入审查
- **工程经理**：建立随团队增长扩展的一致、有记录的架构审查流程
- **CTO**：建立能捕获系统性风险而不制造官僚瓶颈的架构治理机制

---

## 实用提示词

**提示词 1：完整系统设计审查**
```
请对以下系统设计的正确性、可扩展性和故障模式进行审查。

设计背景：
- 系统用途：[描述系统的功能]
- 规模需求：[当前负载、预期增长、SLA]
- 团队背景：[团队规模、运维能力、云服务商]
- 约束条件：[预算、现有技术栈、合规要求]
- 关键非功能性需求：[延迟目标、可用性 SLA、数据持久性]

[在下方粘贴架构图描述或设计文档]

涉及的服务：
- [服务 A：描述其功能、技术栈、通信方式]
- [服务 B：...]
- [数据存储：描述每个，存储哪些数据]
- [外部依赖：第三方 API、服务]

请从以下维度审查：
1. 服务边界正确性和耦合分析
2. 数据模型和一致性模型适宜性
3. 可扩展性瓶颈和水平扩展可行性
4. 单点故障和级联故障风险
5. 安全信任边界和数据流分析
6. 运维就绪性（可观测性、部署、回滚）
7. 生成按严重性分类的发现列表和具体建议
```

**提示词 2：预期增长的可扩展性审查**
```
我们预计未来 12 个月内流量增长 10 倍，需要验证当前架构是否能承受——或了解需要做哪些改变。

当前系统：
- 技术栈：[描述]
- 当前负载：[请求/秒、用户数、数据量]
- 目标负载：[当前的 10 倍，或具体数字]
- 数据库：[类型、规模、连接方式、读写比]
- 缓存：[Redis/Memcached，缓存了什么，TTL，命中率]
- 部署：[单区域/多区域、容器编排、实例类型]

已知瓶颈（如有）：[描述]

[粘贴架构描述或关键设计细节]

请分析：
1. 在 10 倍负载下，架构在哪里会崩溃？（识别具体瓶颈）
2. "扩展悬崖"在哪里——当前方案需要结构性重做的负载是多少？
3. 为 10 倍增长做准备的优先级步骤是什么？
4. 哪些步骤可以在当前架构下完成，哪些需要架构变更？
5. 估算基础设施成本增长，以及架构变更是否能降低它
6. 我们应该使用什么负载测试方法，在流量真正到来前验证？
```

**提示词 3：架构决策记录（ADR）生成**
```
我做了一个架构决策，需要将其正式记录为 ADR。

需要记录的决策：
- 决策内容：[清楚地说明决策，如"我们将使用 Kafka 作为事件总线，而不是 SQS"]
- 背景：[我们在解决什么问题？存在什么约束？]
- 已考虑的替代方案：[列出 2-4 个替代方案，附简要描述]
- 选择方案：[选择了哪个方案，为什么？]
- 已接受的权衡：[这个选择有哪些缺点？]
- 假设条件：[这个决策正确所需要的前提是什么？]

请：
1. 用标准格式撰写正式 ADR（标题、状态、背景、决策、后果、已考虑的替代方案）
2. 强化"后果"部分——识别我可能遗漏的正面和负面后果
3. 为已接受的权衡添加"风险与缓解措施"部分
4. 建议验证步骤：6 个月后我们如何知道这个决策是否正确？
5. 识别应同步记录的相关决策（这个选择所隐含或约束的决策）
```
