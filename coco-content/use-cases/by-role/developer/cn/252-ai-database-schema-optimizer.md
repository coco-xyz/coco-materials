# 使用案例 #252：AI 数据库模式优化器

**角色**：开发者 | **行业**：SaaS、企业软件、电商、金融科技 | **任务**：分析、性能优化、架构

---
## 详细介绍

**痛点：第一年做出的数据库模式决策，决定了未来十年的性能上限**

数据库模式设计是大多数工程团队做出的最高杠杆的基础设施决策——也是他们投入最少专业严谨度的决策。初创公司的初始模式通常由一名开发者在时间压力下设计，表结构反映的是当下的功能需求，而非将在 10 倍、100 倍或 1000 倍规模下决定系统性能的查询模式、数据量或访问特性。这些设计决策会固化下来。之后添加索引很容易，但要重构一张有 5000 万行记录、被 15 个不同服务写入的表，在业务时间内零宕机地完成需要迁移的模式变更——那是一个需要 3 周工程工作的项目。

具体的失败模式已有充分记录。缺失索引是最常见的：开发者为了过滤目的向表中添加了 `user_id` 列，应用在有 1000 行记录的开发环境中运行正常。在生产环境达到 1000 万行时，每个按 `user_id` 过滤的查询都会进行全表扫描，原本 5 毫秒的查询变成 3 秒的查询并导致服务宕机。添加该列的开发者以为 DBA 会添加索引；DBA 以为开发者会指定它。两者都没有发生。

数据类型选择有复合效应。一个创建为 `VARCHAR(255)` 的列——因为"这看起来够用"——在业务需求变化、需要存储更长值时成了一个迁移项目；如果该列是索引的一部分，迁移需要在整张表上重建索引。一个存储 JSON 的 `TEXT` 列——因为"当时结构还不确定"——当查询需要对 JSON 内的字段进行过滤或聚合时成了性能黑洞，因为没有标准 B 树索引的支持，这需要全表扫描。为简单起见选择整数主键，在 21 亿行时触及上限，需要紧急迁移到 BIGINT——这是一个在不采用大量操作复杂度的情况下无法在实时表上零宕机执行的迁移。

**COCO 如何解决这个问题**

COCO 的 AI 数据库模式优化器分析现有模式、查询模式和应用代码，识别性能问题、规范化问题和设计风险，并生成具体的优化建议。

1. **索引分析和建议**：识别缺失、冗余和次优的索引。
   - 分析来自应用代码和慢查询日志的查询模式，识别哪些列需要索引
   - 检测多列 WHERE 子句和 ORDER BY 组合缺少的复合索引
   - 识别冗余索引：被更广泛复合索引取代或从未使用的索引
   - 为大表上的过滤查询推荐部分索引（例如 `WHERE status = 'active'`）
   - 评估频繁连接的外键列的索引覆盖情况
   - 识别高写入表上过度索引导致写入性能下降的索引膨胀问题

2. **数据类型优化**：审查列类型选择的正确性和效率。
   - 识别可以使用更合适类型的列：应该是 ENUM 的 VARCHAR、应该有约束的 TEXT、根据增长轨迹应该是 BIGINT 的 INT
   - 标记 JSON/JSONB 列，并推荐何时应将字段提取为类型化列，何时非结构化存储是合适的
   - 识别时间戳存储问题：将时间戳存储为字符串或整数而非适当的时间戳类型
   - 根据访问模式和查询特性推荐 UUID 与顺序整数与 ULID 主键策略

3. **规范化审查**：评估规范化水平及其权衡。
   - 识别性能的反规范化机会：应该缓存在父表上以避免热查询路径中连接的列
   - 标记过度规范化：增加连接复杂性但没有实质数据完整性收益的关系表
   - 识别将引用完整性强制执行留给应用代码的缺失外键约束
   - 为频繁运行的复杂聚合查询推荐物化视图或汇总表

4. **查询模式分析**：评估模式设计与实际查询模式的对齐程度。
   - 分析针对模式的最频繁查询，识别模式设计与查询模式之间的不匹配
   - 识别根源于模式设计而非应用代码的 N+1 查询来源
   - 推荐允许简化或消除查询的模式变更
   - 评估分页策略，并为大数据集推荐游标分页模式支持

5. **迁移风险评估**：评估推荐模式变更的难度和风险。
   - 对于每个推荐的变更，估算迁移复杂度：微小、中等或高风险
   - 识别哪些变更需要表锁，并估算在当前数据量下的宕机影响
   - 推荐使用 `pt-online-schema-change` 或 `gh-ost` 等工具的在线迁移策略
   - 为高风险变更生成带有适当预防措施的安全迁移脚本

6. **多租户和扩展模式审查**：评估多租户和水平扩展的模式设计。
   - 审查租户隔离策略：行级隔离、每租户模式还是每租户数据库
   - 识别分片就绪性：模式是否可以分区，自然分区键是什么
   - 评估时序或高容量表的表分区机会

**可量化的成果**

- **查询性能改善**：实施 COCO 推荐索引变更的团队报告目标慢查询的中位数性能改善 60-85%
- **模式迁移事件**：使用 COCO 进行上线前模式审查的团队在第一年经历的生产模式迁移事件减少 52%
- **索引效率**：删除冗余索引使高写入表的写入开销平均减少 18%
- **存储效率**：数据类型优化建议使过度指定类型常见的大表存储占用减少 15-30%
- **调查时间**：当 COCO 将模式和查询模式一起分析时，识别数据库性能问题根本原因的时间减少 70%

**受益对象**

- **后端开发者**：在功能开发期间获得专家级的模式设计反馈，在设计决策被实现锁定之前
- **数据工程师**：分析和优化报告和分析工作负载的复杂模式，而无需手动审计每张表和索引
- **数据库管理员**：为没有专用 DBA 覆盖的团队自动化模式审查的第一步
- **工程经理**：在昂贵的模式设计错误发布到生产环境之前捕获它们，避免通常随之而来的高代价补救工作

---
## 实用提示词

**提示词 1：完整模式审查和优化**
```
请审查以下数据库模式的性能、设计质量和优化机会。

模式（粘贴 CREATE TABLE 语句或模式转储）：
[粘贴您的模式 DDL]

数据库系统：[PostgreSQL / MySQL / SQLite 等，版本]
大约数据量：[例如 users 表：200 万行，orders：5000 万行，order_items：2 亿行]
主要查询模式（描述或粘贴最常见的查询）：
[描述前 5-10 种最常见的查询类型，或粘贴代表性 SQL]

应用上下文：
- 类型：[例如 多租户 SaaS、电商、分析平台]
- 读写比例：[例如 80% 读，20% 写]
- 峰值并发连接数：[大约]

请分析并报告：
1. 缺失索引：哪些列需要索引，以及什么类型（单列、复合、部分）？
2. 应该删除的冗余或未使用索引
3. 数据类型问题：列的类型与存储数据不匹配
4. 规范化问题：过度或不足规范化，附具体建议
5. 缺失的外键约束（通过命名规范或查询模式识别）
6. 在当前数据量 10 倍时的前 3 个性能风险
7. 按优先级排列的优化建议，附预估影响
```

**提示词 2：通过模式分析慢查询根本原因**
```
我有一些慢查询，我认为是由模式设计问题导致的。帮我找出根本原因并修复。

慢查询（粘贴实际 SQL，包括 WHERE 子句）：
[粘贴慢查询]

每个查询的 EXPLAIN / EXPLAIN ANALYZE 输出：
[粘贴查询计划]

涉及的表的模式：
[粘贴相关表的 CREATE TABLE 语句]

这些表上的现有索引：
[粘贴索引定义]

性能目标：[例如 此查询需要在有 1000 万行的表上在 100 毫秒内运行]

请：
1. 解释每个查询为何缓慢，参考查询计划
2. 哪些模式变更（新索引、类型变更、反规范化）最能改善性能？
3. 显示每个推荐模式变更的精确 DDL
4. 模式变更后，新的查询计划会是什么样？（描述预期改善）
5. 是否有即使没有模式变更也能帮助的查询重写？
6. 在当前表大小下，每个模式变更的估算迁移风险是多少？
```

**提示词 3：索引策略设计**
```
我需要根据我们的查询模式为以下表设计一个全面的索引策略。

表模式：
[粘贴 CREATE TABLE 语句]

访问这些表的所有查询（粘贴 SQL——每种变体都重要）：
[粘贴所有查询变体]

当前索引：
[列出或粘贴当前的索引定义]

约束：
- 写入量：[每秒大约的插入/更新/删除次数]
- 可接受的索引存储开销：[例如 我们最多可以承受表存储的 2 倍用于索引]
- 维护窗口可用性：[我们是否可以为索引创建停机？]

请：
1. 对于每个查询，识别是否被现有索引完全覆盖
2. 推荐新索引，指定：列顺序、索引类型（B 树、哈希、GIN 等）以及是否部分
3. 识别哪些现有索引作为冗余应该删除
4. 解释推荐索引集的写入性能权衡
5. 应该按什么顺序创建索引以实现最小风险和最大早期收益？
6. 创建后我应该运行哪些监控查询来验证索引使用情况？
```

**提示词 4：模式迁移安全审查**
```
我需要对生产数据库表进行模式变更，需要帮助评估风险并规划迁移。

该表：[表名]
当前模式：[粘贴 CREATE TABLE 语句]
表大小：[大约的行数和存储大小]
写入量：[每分钟对该表的大约写入次数]
宕机容忍度：[需要零宕机 / 可接受短暂维护窗口]

提议的模式变更：
[描述每个变更：添加列、修改类型、添加索引、添加约束等]

数据库系统和版本：[例如 PostgreSQL 15]
可用工具：[例如 pt-online-schema-change、gh-ost、原生在线 DDL]

请：
1. 对每个提议的变更分类：安全在线（无锁）/ 短暂锁（毫秒级）/ 长时间锁（分钟以上）
2. 哪些变更需要特殊迁移工具？哪些可以使用原生 ALTER TABLE？
3. 为每个变更提供精确的迁移 SQL 或命令
4. 进行多个变更的推荐顺序是什么？
5. 迁移执行期间我应该监控什么以便尽早发现问题？
6. 如果出了问题，每个变更的回滚程序是什么？
7. 迁移前检查清单：在生产环境运行此迁移之前我应该验证什么？
```

**提示词 5：多租户模式设计审查**
```
我正在设计（或审查）多租户 SaaS 应用的模式，需要评估隔离策略和性能特性。

当前或提议的模式（聚焦于租户相关设计）：
[粘贴相关模式章节]

当前使用的隔离策略：[行级 / 每租户模式 / 每租户数据库 / 混合]
租户数量（当前及预计 2 年增长）：[例如 现在 50 个，预计 2 年内 2000 个]
租户规模变化：[例如 大多数租户有不到 1000 条记录，但最大的有 500 万条]
合规要求：[例如 数据驻留、PII 隔离、GDPR]

请评估：
1. 隔离策略是否适合租户规模和合规要求？
2. 当前模式如何处理租户数据隔离——风险是什么？
3. 是否有缺失的 tenant_id 索引会导致跨租户查询性能问题？
4. 随着最大租户的增长，模式将如何表现？失效点在哪里？
5. 如果我们需要水平分区，什么分片策略适用于此模式？
6. 改善多租户模式的建议，附每项的迁移复杂度评估
```

---
