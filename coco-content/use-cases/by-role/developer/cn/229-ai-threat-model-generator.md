# Use Case #229: AI Threat Model Generator

**Role**: Developer / Security Engineer / Tech Lead / Application Architect | **Industry**: Technology, SaaS, Fintech, Healthcare, Enterprise Software | **Task**: Threat Modeling, Security Architecture, Risk Assessment

---
## 详细介绍

**痛点：安全审查发生得太晚，覆盖得太少**

威胁建模被普遍认可为安全软件开发的最佳实践——也被普遍忽视。原因是结构性的。威胁建模需要跨领域专业知识：应用架构知识、安全领域知识（攻击模式、威胁行为者、STRIDE/DREAD 框架），以及从对手角度系统性思考系统的能力。大多数研发团队拥有深厚的应用知识，但安全领域知识有限。安全团队拥有深厚的安全知识，但长期人手不足——典型企业的安全团队需要支持的开发者数量是其能够有效参与设计评审的 10–20 倍。

后果是可预测的：安全审查发生在错误的时间（对已在生产的系统进行渗透测试），也发生在错误的层面（漏洞扫描发现实现层 Bug，而非设计缺陷）。STRIDE 威胁建模方法识别了六类威胁——欺骗（Spoofing）、篡改（Tampering）、抵赖（Repudiation）、信息泄露（Information Disclosure）、拒绝服务（Denial of Service）和权限提升（Elevation of Privilege）——这些威胁存在于设计层面，在部署后修复的成本极为高昂。一个在威胁模型中发现的信息泄露威胁，开发者在设计阶段修复需要 4 小时。同样的设计缺陷在泄露调查中发现，成本高出数个数量级，并带来远超工程成本的监管和声誉后果。

文档化问题让技能差距进一步扩大。即使进行了威胁建模，输出结果往往是一张白板照片和一些非正式笔记——而非可以审查、维护和在未来开发中参考的系统性文档。安全债务因此既不可见（没有人知道哪些威胁被考虑过），也无法管理（没有基准与系统变更时进行对比）。新功能被添加到原始威胁模型已两年未更新的系统中，引入了没有人仔细思考过的新攻击面。

**COCO 如何解决**

COCO 的 AI 威胁建模生成器从架构描述、数据流图和信任边界定义中创建系统性的 STRIDE/DREAD 威胁模型——在不要求每个团队都有内部安全架构师的情况下，实现安全设计审查的普及化。

1. **基于架构的威胁识别**：COCO 从系统结构而非通用检查清单中推导威胁。
   - 分析数据流图（DFD）或架构描述，识别所有数据入口点、信任边界跨越、数据存储和外部实体
   - 系统性地对每个组件和数据流应用 STRIDE 方法：这个认证接口存在哪些欺骗攻击？这个数据存储存在哪些篡改攻击？
   - 识别技术栈特定的威胁：使用 OAuth2 的应用的 OAuth2 错误配置、基于 ORM 的数据库访问的 SQL 注入风险、获取用户控制 URL 的服务的 SSRF 风险
   - 考虑部署环境：Kubernetes 特定威胁（Pod 逃逸、RBAC 错误配置）、云特定威胁（IAM 权限提升、元数据服务 SSRF）、Serverless 威胁（冷启动时序攻击、函数劫持）

2. **STRIDE 威胁矩阵生成**：结构化、全面且具体。
   - 为每个组件生成完整的 STRIDE 矩阵：欺骗、篡改、抵赖、信息泄露、拒绝服务、权限提升
   - 每个威胁条目包含：威胁描述、攻击者画像、攻击场景、攻击前提、潜在影响和现有/建议的缓解措施
   - 将相关威胁归组以显示攻击链——攻击者可能组合起来实现重大目标的步骤序列
   - 区分有意威胁（对手驱动）和意外威胁（错误配置、意外数据暴露）

3. **DREAD 风险评分**：按风险对威胁排序，让团队专注于最重要的事情。
   - 在 DREAD 维度对每个威胁评分：破坏潜力（Damage）、可重现性（Reproducibility）、可利用性（Exploitability）、受影响用户（Affected users）、可发现性（Discoverability）
   - 生成风险优先级威胁登记册：上线前必须处理的关键威胁、下季度处理的高危威胁、监控的中/低级威胁
   - 根据系统上下文调整评分：对于含 PHI 的医疗系统，低严重性威胁的评级与内部分析仪表盘不同
   - 为每个威胁提供置信度评级：基于可用架构信息，这个威胁的确定性有多高？

4. **缓解建议**：每个已识别的威胁都附有可操作的防御指导。
   - 将每个威胁映射到具体的技术缓解措施，并附实现指导："对于这个 CSRF 威胁：实现 SameSite=Strict Cookie，并使用 [框架特定实现] 验证 CSRF Token"
   - 为每个威胁类别引用 OWASP、NIST 和 CIS 基准指导
   - 区分：消除威胁（移除攻击面）、缓解风险（使利用更困难）、接受并监控（带检测的残余风险）或转移（保险、第三方）
   - 当主要缓解措施无法立即实施时，识别补偿性控制措施

5. **信任边界与数据流映射**：捕获隐性假设的正式定义。
   - 识别系统中的所有信任边界：经过认证的上下文在哪里结束？数据在哪里被验证？权限级别在哪里变化？
   - 追踪敏感数据的数据流：PII、金融数据、凭证——从摄取到处理到存储和出口
   - 识别跨越信任边界但没有适当验证或清洗的数据
   - 记录假设（如"内部网络流量被信任"），将隐性信任转化为明确的安全决策

6. **动态威胁模型维护**：随系统演进保持威胁模型更新。
   - 生成版本化的威胁模型文档，随功能添加可增量更新
   - 提供变更影响分析："新功能 X 引入了 [N] 个新的威胁场景，具体如下..."
   - 与开发工作流集成：威胁模型检查作为功能设计评审的一部分
   - 追踪缓解实施状态：哪些已识别的威胁已被处理，哪些仍未解决

**可量化的结果**

- **威胁覆盖率**：COCO 生成的威胁模型平均比非结构化安全评审多识别 3–4 倍的威胁
- **上线前问题检测**：渗透测试发现的 55% 的关键安全问题可从威胁模型分析中预测；在设计阶段捕获它们的成本低 20–100 倍
- **安全审查普及化**：工程团队可以在 3–4 小时内自行进行初步威胁建模，而非需要 2 周的安全团队参与
- **缓解率**：有系统性威胁模型的团队在上线前修复 70% 的高优先级威胁，无威胁模型的只有 30%
- **合规支持**：威胁模型文档满足 ISO 27001、SOC 2 和 HIPAA 安全审查证据的 STRIDE 要求
- **安全债务减少**：季度威胁模型评审捕获 80% 的功能开发引入的新攻击面

**受益角色**

- **软件开发者**：通过结构化的、系统特定的威胁场景（而非通用安全建议）学会对自己的代码采取对抗性思维
- **安全工程师**：通过审查 AI 生成的威胁模型扩大影响力，而非从头开始进行每次会话
- **技术负责人 / 架构师**：从一开始就将安全纳入设计决策，而非作为开发后的门控
- **合规与风险团队**：获得满足监管审计要求的有文档的系统性安全分析

---

## 实用提示词

**提示词 1：完整应用威胁建模**
```
为以下应用生成全面的 STRIDE 威胁模型。

应用背景：
- 应用类型：[Web 应用 / 移动后端 / 微服务 / 数据管道 / 等]
- 行业/合规背景：[通用 SaaS / 金融科技（PCI DSS）/ 医疗（HIPAA）/ 等]
- 用户类型：[匿名用户 / 认证用户 / 管理员用户 / API 客户端]
- 部署方式：[云服务商、Kubernetes / Serverless / 传统 VM]

架构概述：
[描述系统——列出组件、通信方式、处理的数据]

关键组件：
- 前端：[技术栈，认证方式]
- API 层：[框架，认证，授权方式]
- 数据库：[类型，存储了哪些敏感数据]
- 外部集成：[支付处理器、邮件服务、OAuth 提供商等]
- 后台任务：[描述任何异步处理]

数据分类：
- 收集的 PII：[存储了哪些用户数据]
- 金融数据：[如有]
- 凭证：[密码、Token、API Key 如何存储]

请生成：
1. 涵盖所有主要组件和数据流的完整 STRIDE 矩阵
2. 按风险优先级排序的 DREAD 评分威胁登记册
3. 信任边界图（文字描述）
4. 前 10 个最高优先级威胁，附具体的缓解建议
5. [相关合规框架] 的合规差距分析
```

**提示词 2：新功能安全威胁分析**
```
我正在向现有系统添加新功能，需要对新攻击面进行威胁建模。

现有系统背景（简要）：
- 功能：[描述]
- 当前安全状态：[认证类型，已有的关键保护措施]

新功能描述：
- 功能：[详细描述新功能]
- 收集/处理的新数据：[描述]
- 新的外部集成：[有新的第三方服务吗？]
- 新的用户侧功能：[用户现在能做之前不能做的什么？]
- 新的 API 接口或数据流：[描述]
- 新的后台进程：[如有]

请：
1. 识别此功能引入的新攻击面
2. 对每个新组件和数据流应用 STRIDE
3. 识别新功能与现有系统交互产生的新威胁
4. 用 DREAD 评分并排序威胁
5. 为前 5 个威胁提供具体的实现指导
6. 列出此功能上线前应满足的安全验收标准
```

**提示词 3：认证与授权系统威胁建模**
```
我需要对我们的认证和授权系统进行专项威胁建模。

认证系统详情：
- 认证方式：[用户名/密码 / OAuth2 / SAML / 魔术链接 / MFA——哪些因素？]
- Session 管理：[JWT / 服务端 Session / Cookie 配置]
- 授权模型：[RBAC / ABAC / ACL / 自定义]
- Token 客户端存储：[localStorage / httpOnly Cookie / 内存]
- 密码存储：[bcrypt / Argon2 / 其他]
- 账户恢复：[邮件链接 / 安全问题 / SMS / 其他]
- 集成的 OAuth 提供商：[Google / GitHub / 其他]

已知关注点：
- [如"我们使用 JWT，不确定我们的过期/撤销是否安全"]
- [如"密码重置流程感觉比较薄弱"]
- [如"我们还没有 MFA，正在添加——想先建模"]

请生成：
1. 认证和授权系统的完整 STRIDE 分析
2. 最高风险组件的具体攻击场景（凭证填充、Token 伪造、权限提升）
3. 如适用，JWT 专项威胁分析（算法混淆、弱密钥、过期绕过）
4. 如适用，OAuth2/OIDC 专项威胁（授权码注入、State 参数攻击）
5. 每个已识别威胁的加固建议，附实现细节
6. 验证每项缓解措施安全性的测试用例
```
