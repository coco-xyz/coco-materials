# #398 — AI SQL 查询优化器

**角色**：数据科学家
**行业**：SaaS / 科技
**任务**：分析
**标识**：`ai-sql-query-optimizer`

---

## 简介

SQL 仍然是机器学习工作流中数据访问的主导语言。特征工程、训练数据提取、模型评估查询、监控仪表板——所有这些都在 BigQuery、Snowflake、Redshift 或 Databricks SQL 等数据仓库上以 SQL 运行。随着数据集从 GB 级增长到 TB 级，优化良好与优化不当的 SQL 查询之间的差距不再是秒级，而是小时和金钱。一个每日对 5TB 仓库表运行的糟糕特征工程查询，仅计算成本每月就可能高达数千美元，如果遗漏了分区过滤器，每次运行可能扫描整张表。

挑战在于，分析型工作负载（OLAP）的 SQL 优化需要与事务型数据库（OLTP）不同的技能。数据科学家通常擅长编写正确的 SQL——正确的连接、正确的聚合、正确的窗口函数。但他们往往不擅长：选择正确的聚簇和分区键、理解公共表表达式（CTE）何时物化与何时被查询优化器内联、编写避免全表扫描的高效窗口函数、在适当时使用 APPROX_COUNT_DISTINCT 代替 COUNT(DISTINCT)，或了解何时将复杂查询拆分为多个物化中间步骤。

财务影响是显著的。一个执行 30 分钟全表扫描的 Snowflake 查询，通过适当的分区剪枝往往可以缩短至 2 分钟，节省 93% 的计算成本。一个对 6 个月事件数据错误使用 COUNT(DISTINCT user_id) 的 BigQuery 查询，可能扫描 500GB 并每次花费 ¥21 元——每天运行 100 次，即每天 ¥2,100 元或每年 ¥76 万元，仅仅是一个查询。许多数据团队都有这样的"失控查询"，他们甚至不知道，因为成本被分摊在仓库账单账户中，而非归因到单个查询。

COCO 充当专家级 SQL 优化顾问，分析查询模式、识别低效之处，并以具体说明改进的方式重写查询。工作流程如下：

1. **粘贴查询并提供背景。** 分享 SQL、涉及表的模式、近似表大小以及你使用的仓库或引擎。
2. **描述性能问题。** 分享查询执行时间、扫描数据量估计，或者如有的话提供成本信息。
3. **COCO 识别优化机会。** 检查查询的：分区过滤器使用、连接顺序效率、窗口函数效率、反模式检测（SELECT *、不必要的 DISTINCT、相关子查询），以及近似化机会。
4. **获得带注释的重写查询。** 优化版本包含内联注释，解释每项变更及其对性能的帮助。
5. **针对边缘情况迭代。** 如果优化后的查询在你识别的边缘情况下产生不同结果，COCO 帮助在保持优化的同时解决差异。

使用 COCO 进行 SQL 优化的数据团队报告，平均查询执行时间减少 67%，每个优化关键查询平均每月节省 ¥8,500 的计算成本。

**受益角色：**

- **数据科学家**：编写复杂的特征工程 SQL，需要在生产化前优化成本和速度
- **分析工程师**：dbt 模型运行缓慢或成本高昂，需要调优
- **ML 工程师**：在紧张的调度窗口内运行训练数据提取查询，需要确保在 SLA 时间窗口内完成
- **数据平台负责人**：希望通过识别和修复团队内昂贵的查询模式来降低仓库计算成本

---

## 实用提示词

**提示词 1 — 全面查询性能优化**
```
我有一个运行太慢、成本太高的 SQL 查询。请帮我优化它。

数据仓库：[BigQuery / Snowflake / Redshift / Databricks SQL / 其他]
当前执行时间：[N 分钟]
扫描数据量：[N GB/TB，如有]
每次运行估计成本：[¥X，如有]
运行频率：[运行间隔]

表结构：
[表1]：[N 行，N GB]，按 [列名] 分区，按 [列名] 聚簇
[表2]：[N 行，N GB]，按 [列名] 分区

SQL 查询：
```sql
[粘贴您的查询]
```

已知问题（如有）：[描述您的怀疑]

请分析查询，识别所有优化机会，并提供带内联注释（解释每项变更）的重写版本。
```

**提示词 2 — 窗口函数优化**
```
我在特征工程 SQL 中使用了窗口函数，怀疑它们可能导致性能问题。

数据仓库：[仓库]
表：[表名]，[N 行]，[分区方式]

当前带窗口函数的 SQL：
```sql
[粘贴带窗口函数的 SQL]
```

当前性能：[执行时间，扫描数据量]

请帮我：(1) 识别我的 PARTITION BY 和 ORDER BY 子句是否高效，(2) 检查是否有不必要的表重复扫描，(3) 如果窗口函数不是这里的正确工具，建议替代方法，(4) 如适用，优化 frame 子句（ROWS vs RANGE）。
```

**提示词 3 — BigQuery 专项优化**
```
我有一个 BigQuery 查询扫描了过多数据。请帮我添加合适的分区和聚簇过滤器。

项目/数据集：[项目.数据集]
表：[表名]
表大小：[N TB]
分区列：[列名，DATE/TIMESTAMP/INTEGER 类型]
聚簇列：[列名]

查询：
```sql
[粘贴查询]
```

BigQuery 控制台的查询执行详情：
- 处理字节数：[N GB]
- Slot ms：[N]
- 阶段时序：[如有请粘贴]

请优化：(1) 最大化分区剪枝，(2) 使用聚簇过滤器，(3) 在不需要精确值的地方使用近似函数，(4) JOIN 顺序和广播机会，(5) 是否应将某些 CTE 物化为中间表。
```

**提示词 4 — 训练数据提取查询**
```
我使用以下 SQL 查询提取 ML 模型的训练数据。它需要在 [N 分钟] 的 SLA 窗口内完成，但目前需要 [M 分钟]。

使用场景：[查询的功能——如"提取 6 个月的客户行为特征用于流失模型训练"]
数据仓库：[仓库]
数据量：[N 行输出，N GB 扫描]

SQL：
```sql
[粘贴提取查询]
```

约束条件：
- 输出必须精确（不允许改变结果的近似值）
- [其他约束]

请优化查询以满足 [N 分钟] SLA：(1) 添加缺失的分区/日期过滤器，(2) 消除全表扫描，(3) 如有益处重新排序 JOIN，(4) 如果单查询优化不够，建议使用多步骤中间物化表的方法。
```

**提示词 5 — 反模式审查与代码质量**
```
请审查我的 SQL 代码以发现常见反模式和最佳实践问题。我希望同时改善性能和可维护性。

数据仓库：[仓库]
用途：[查询的功能]

SQL：
```sql
[粘贴您的完整查询]
```

请检查：(1) 性能反模式（SELECT *、不必要的 DISTINCT、相关子查询、隐式交叉连接），(2) 正确性风险（NULL 处理、连接类型正确性、窗口函数边缘情况），(3) 可维护性问题（魔法数字、不清晰的别名、复杂逻辑缺少注释），(4) 重构为更清晰的 CTE 或模块化 dbt 模型的机会。
```
